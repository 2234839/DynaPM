# DynaPM

[english documentation](./README.md)

这是一个动态启停程序的管理程序，具有一些类 serverless 特性。目的是为了在私有化部署\资源受限的情况下使用少量内存和 cpu 维持大量低频访问+少数高频访问的程序同时可以提供在线服务。

每次用户访问其中某个程序时，如果该程序离线则网关暂时挂起请求同时立刻启动程序，程序启动完毕后网关充当反向代理。内存不足，或程序长时间无人访问时自动关闭程序解决服务器资源。

使用 pm2 启动最简单的 node http 程序大概耗时 600ms

## 快速开始

```bash
pnpm i dynapm -g
dynapm ./apps.json
```

## 引言

我经常想写一些长期运行的程序，我既希望能够随时打开这些程序的网站，或者调用他们的接口。但显然这些程序并不是时刻都在工作的，所以我还希望在没有工作的时候他们除了磁盘空间外一点点 cpu 和 ram 都不占用。所以我以前看中了 serverless ,但 serverless 在部署等方面还是比较麻烦，而且并没有办法利用我的空闲服务器。

现在我可以利用 DynaPM 保持成千上万个程序的随时伺服，只要我的磁盘空间还够用当然受限于机器的实际情况峰值同时运行的程序可能只有几十个，但事实上我过去写的大部分程序的伺服时间并不长，所以这个限制应该不会成为问题。

## 特性

- [x] 请求到来时才使用 pm2 启动 hostname 所对应的程序
- [x] 空闲时关闭程序
- [ ] 支持自动扩容
- [ ] 支持持久运行（支持当空闲 ram 不足时才关闭程序）
- [ ] 支持 cron 定时任务
- [ ] 支持动态启停 docker 容器
- [ ] 支持 spawn / fork 的形式启动程序

## 性能

### fastify + @fastify/reply-from

在冷启动完毕后，运行 `autocannon http://127.0.0.1:83` 测试性能是平均 3000 req/s。

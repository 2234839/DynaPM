# DynaPM 性能基准测试报告

## 测试环境

- **Node.js 版本**: v22.x
- **测试工具**: autocannon + 自定义测试脚本
- **测试时间**: 2026-02-10
- **配置**: `agent: undefined`（每次创建新连接，无连接复用）
- **后端服务**: Node.js http 模块（单线程）

---

## 基线性能数据 (v1.0.12)

### 1. 冷启动性能

```
冷启动总耗时: 201ms
├─ DynaPM 开销:   ~25ms (启动命令 + 端口等待)
└─ 服务启动时间:   ~176ms (Node.js 应用)
```

**说明**：
- DynaPM 的冷启动开销为 25ms（这是固定的框架开销）
- 服务启动时间取决于具体应用类型（Node.js 应用约 176ms）

### 2. 流式代理延迟

```
平均延迟: 11.7ms
最小延迟: 11ms
最大延迟: 13ms
延迟范围: 11ms - 13ms
```

**说明**：
- 这是服务已运行状态下的单次请求延迟
- 主要瓶颈在 Node.js `http.request` 到后端的连接开销（~6-8ms）
- uWS 接收请求和流式转发各占约 1-2ms

### 3. 网关吞吐量（多服务混合压测）

```
网关总 QPS:     4777 req/s
测试服务数:     3 个
每服务并发数:   50
总并发数:       150
测试时长:       5 秒

各服务 QPS 详情:
  - app1.test:  1615.0 req/s
  - app2.test:  1561.0 req/s
  - app3.test:  1601.0 req/s
```

**说明**：
- 这是网关同时处理 3 个不同服务的真实性能
- 每次请求都创建新的 TCP 连接（无连接复用）
- 高并发下延迟保持在 11ms 左右
- **注意**: 当前测试使用 Node.js 单线程后端服务，可能存在瓶颈

---

## 性能瓶颈分析

### 当前架构的请求延迟分布

```
总延迟 ~11.7ms 的分布：
├─ uWS 接收请求:            ~1ms
├─ URL 构建 + 请求头处理:    ~0.5ms
├─ Node.js http.request:     ~6-8ms  ← 主要瓶颈
│  ├─ DNS 查询:             ~0.5ms (本地缓存)
│  ├─ TCP 三次握手:         ~2-3ms
│  ├─ TLS 握手 (HTTPS):     ~2-3ms
│  └─ 请求发送:             ~1-2ms
├─ 后端服务处理:            ~2-3ms
└─ uWS 流式转发:            ~1-2ms
```

### 为什么 Node.js http.request 是瓶颈？

1. **每次创建新连接**：当前 `agent: undefined`，每次请求都建立新的 TCP 连接
2. **TCP/TLS 握手开销**：即使连接到本地服务，每次也需要 6-8ms 的握手时间
3. **HTTP/1.1 的限制**：不支持真正的多路并发，即使使用 keep-alive

### 测试服务瓶颈问题

**当前问题**：
- 测试使用 Node.js 单线程 http 模块作为后端
- 可能成为性能瓶颈，无法真实反映网关性能

**改进方案**：
- 使用 uWebSockets.js 作为测试服务（性能极高）
- 使用 wrk 替代 autocannon（C 编写，性能更高）

---

## 优化目标

### 目标 1: 降低延迟

**当前**: 平均 11.7ms
**目标**: < 8ms（减少 ~30%）

**方案**：
- 实现 HTTP/2 多路复用（单连接复用，消除握手开销）
- 优化请求处理流程（减少同步等待）

### 目标 2: 提升吞吐量

**当前**: 4777 req/s
**目标**: > 8000 req/s（提升 ~60%）

**方案**：
- HTTP/2 连接复用（减少连接建立开销）
- 使用 uWS 测试服务（消除后端瓶颈）
- HTTP/1.1 连接池（降级方案，平衡延迟和吞吐量）

### 目标 3: 支持降级机制

- 优先使用 HTTP/2（多路复用，最低延迟）
- 后端不支持 HTTP/2 时自动降级到 HTTP/1.1
- 确保所有后端服务都能正常工作

---

## 优化计划

### 阶段 1: 改进测试环境 ⏳

**实现内容**：
1. 使用 uWS 作为测试后端服务（性能极高，无瓶颈）
2. 集成 wrk 压测工具（优先于 autocannon）
3. 重新测试获得真实的性能基线

**预期效果**：
- 获得更准确的性能数据
- 确保瓶颈不在测试服务

### 阶段 2: HTTP/2 多路复用实现 🔜

**实现内容**：
1. 创建 HTTP/2 会话连接池（单 TCP 连接，多流并发）
2. 修改代理请求逻辑支持 HTTP/2
3. 实现自动降级到 HTTP/1.1

**预期效果**：
- 延迟降低至 ~6-8ms（消除 TCP/TLS 握手）
- QPS 提升至 ~8000+ req/s

### 阶段 3: 性能分析日志 🔜

**实现内容**：
1. 添加详细的性能计时点
2. 记录每个阶段的耗时
3. 支持开关控制（仅优化时启用）

---

## 测试命令

```bash
# 运行性能测试
pnpm benchmark

# 输出纯净日志（无颜色控制符）
NO_COLOR=1 pnpm benchmark

# 查看性能日志（启用性能分析后）
# 需要在配置中设置 enablePerformanceLog: true
```

---

## 版本历史

| 版本 | 日期 | QPS | 延迟 | 说明 |
|------|------|-----|------|------|
| 1.0.12 (baseline) | 2026-02-10 | 4777 | 11.7ms | 基线版本，每次创建新连接，Node.js 后端 |

name: Release to npm

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.4

permissions:
  contents: read
  # å…³é”®é…ç½®ï¼šå…è®¸ GitHub Actions ç”Ÿæˆ OIDC ä»¤ç‰Œ
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build package
        run: pnpm build

      - name: Verify build output
        run: |
          echo "ðŸ“¦ æ£€æŸ¥æ‰“åŒ…è¾“å‡º..."
          ls -la dist/src/
          if [ ! -f dist/src/index.js ]; then
            echo "âŒ ä¸»å…¥å£æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ‰“åŒ…è¾“å‡ºæ­£å¸¸"

      - name: Verify npm version
        run: |
          npm_version=$(npm -v)
          echo "ðŸ“¦ npm ç‰ˆæœ¬: $npm_version"
          echo "âœ… Node.js 24 è‡ªå¸¦çš„ npm ç‰ˆæœ¬æ»¡è¶³ OIDC è¦æ±‚"

      - name: Publish to npm
        run: npm publish --provenance
        # ä½¿ç”¨ OIDCï¼Œä¸éœ€è¦ NPM_TOKEN
        # --provenance æ ‡å¿—å¯ç”¨åŒ…æº¯æºï¼ˆnpm æŽ¨èçš„å®‰å…¨å®žè·µï¼‰

      - name: Extract release notes from CHANGELOG
        run: |
          # èŽ·å–ç‰ˆæœ¬å·ï¼ˆåŽ»æŽ‰ v å‰ç¼€ï¼‰
          VERSION=${{ github.ref_name }}
          VERSION_NUMBER=${VERSION#v}

          # ä»Ž CHANGELOG.md æå–å¯¹åº”ç‰ˆæœ¬çš„å†…å®¹ï¼Œä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
          sed -n "/## \[$VERSION_NUMBER\]/,/## \[/p" CHANGELOG.md | head -n -1 | tail -n +2 > RELEASE_NOTES.md

          # å¦‚æžœæ–‡ä»¶ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "ðŸ“¦ Release $VERSION" > RELEASE_NOTES.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false

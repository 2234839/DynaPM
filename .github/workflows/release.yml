name: Release to npm

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.4

permissions:
  contents: read
  # å…³é”®é…ç½®ï¼šå…è®¸ GitHub Actions ç”Ÿæˆ OIDC ä»¤ç‰Œ
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build package
        run: pnpm build

      - name: Verify build output
        run: |
          echo "ğŸ“¦ æ£€æŸ¥æ‰“åŒ…è¾“å‡º..."
          ls -la dist/src/
          if [ ! -f dist/src/index.js ]; then
            echo "âŒ ä¸»å…¥å£æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ‰“åŒ…è¾“å‡ºæ­£å¸¸"

      - name: Run tests
        run: pnpm test

      - name: Publish to npm
        run: npm publish --provenance
        # ä½¿ç”¨ OIDCï¼Œä¸éœ€è¦ NPM_TOKEN
        # --provenance æ ‡å¿—å¯ç”¨åŒ…æº¯æºï¼ˆnpm æ¨èçš„å®‰å…¨å®è·µï¼‰

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
